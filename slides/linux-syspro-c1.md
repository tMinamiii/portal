---
marp: true
theme: gaia

---

# 1章 概要および主要概念

<style>
{
font-size: 22px;
}
</style>

- 本書はシステムプログラミング（system programming）、すなわちシステムソフトウェア（system software） 開発の真髄を解説するものです
- GUI アプリケーションなど他のソフトウェアはほとんどがより上位に位置し、下位のソフトウェア、ハードウェアへアクセスすることは極めてまれか、もしくは全くありません
- 上位(GUI)のシステム概念の単なる土台になるのがシステムプログラミングです
- システムプログラミングに対する理解はすべてのプログラマに必須と言えます

- Linus Torvalds、Linuxを作った人(gitも)
[![Image from Gyazo](https://i.gyazo.com/81a46bb3d011bc133514477914987640.jpg)](https://gyazo.com/81a46bb3d011bc133514477914987640)

---

## 1.1 システムプログラミング

本書はこの疑問および以下のような疑問に答えるためのものです。

- Linux でシステムレベルのアプリケーションを開発するにはどうすれば良いか。
- カーネルや C ライブラリが提供するものは具体的に何か。
- 効率的なソースコードを記述するには、また Linux ではどんな仕掛けが用意されているか。
- 他のUnixシステムと比べて、Linuxではどんな巧妙なシステムコールが用意されているか。また、どんな動作をするのか。

Linux のシステムプログラミングでは重要なものが 3 つあります。
- システムコール
- C ライブラリ
- C コンパイラです。
まずそれぞれについて概要をまとめます。

---

### 1.1.1 システムコール

システムコールとは、ユーザー空間からOSに何らかの動作やリソースを要求するための、カーネル機能を呼び出す物

- read(): ファイルディスクリプターから読み込む
- write(): ファイルディスクリプター (file descriptor) に書き込む
- get_thread_area(): スレッド局所記憶領域を取り出す
- set_tid_Address(): thread IDのポインタを設定する ?

---

### ファイルディスクリプタとは？

> ファイル（への通り道）に割り振られる番号で、ファイルを識別するための目印

 ([「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典](https://wa3.i-3-i.info/word14383.html)) より


>プログラムが特定のファイルを指定して「開く」操作を行うと、カーネル内のファイルテーブルと呼ばれる領域に対応する項目が作成され、対象ファイルのストレージ上での位置（パス）、ファイル内の現在の操作位置などの情報が記録される。

>このテーブル内での当該ファイルの識別番号がファイルディスクリプタで、以降はプログラムからファイルディスクリプタを指定して、どのファイルへの操作なのかをカーネルに伝達する。

>通常、ファイルディスクリプタは0から順番に未使用の最も小さい値が与えられるようになっており、プログラム上では整数型の変数などとして扱われる。ただし、番号によっては固定的に特殊な対象を表す場合があり、一般的には「0」は標準入力（stdin）、「1」は標準出力（stdout）、「2」は標準エラー出力（stderr）としてプログラムの実行中は常に開いた状態になっている。

([IT用語辞典 e-Words](https://e-words.jp/w/%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF.html))

---

### スレッド局所記憶領域(thread local storage, TLS)

- グローバル変数がプロセスごとに割り当てる変数
- スレッドローカル変数はスレッドごとの領域に割り当てられています。その領域をスレッドローカルストレージという
    - errno: errnoは、マルチスレッドという概念が導入される前のもの。スレッドローカルにしないと各スレッドでのシステムコール呼び出しの結果で errno が上書きされるという事故に繋がります

---

#### 1.1.1.1 システムコールの発行(コール)  1/3

- ユーザーアプリケーションが直接的にカーネル内のコードを実行したり、データを操作することは禁止されている

- カーネル定義した方法にしたがって、アプリケーションからカーネルへ入り(trap)許可された範囲でカーネルコードを実行
    - /kernel/traps.c: 割込みハンドラとしてシステムコールが登録されている

- i386(32bit)システムでは、ユーザーアプリケーションがソフトウェア割り込み命令**int**(interrupt ?) を実行します。割り込み番号は 0x80 (`int 0x80`という命令が実行される)。

- 割り込み番号は `0x80`(int 0x80。この割り込み命令によりカーネル空間、すなわち**ソフトウェア割り込みハンドラを実行するカーネル内の保護された空間**へと切り替わりる。

---

#### 1.1.1.1 システムコールの発行(コール)  2/3 (アセンブリ言語)

<style>
pre > code {
  font-size: 17px;
}
</style>

```assembly
.globl _start
_start:
    movl $4,%eax /* write system call number */
    movl $1,%ebx /* stdout */
    movl $msg,%ecx /* the data to print */
    movl $13,%edx /* length of the buffer */
    int $0x80 /* システムコール実行 割り込み実行 */

    movl $1,%eax /* exit system call number */
    movl $0,%ebx /* exit status */
    int $0x80

.data
    msg: .asciz "Hello,World\n"
```

```sh
➜ ~ as -o main.o main.S
➜ ~ ld -o main.out main.o
➜ ~ ./main.out
hello,World
➜ ~
```

- [アセンブリコードで「int0x80」とはどういう意味ですか？](https://codehero.jp/assembly/1817577/what-does-int-0x80-mean-in-assembly-code)
- [さくっとアセンブリ入門 hello,world編](https://rabbitfoot141.hatenablog.com/entry/2016/05/01/124410)

---

#### 1.1.1.1 システムコールの発行(コール)  2/3 (C言語)

```c

#include<unistd.h>

int main(){
  const void *string = "Hello,World!\n";
  write(1, string, 13);
  return 0;
}

```

```sh
➜ ~ gcc write.c
➜ ~ ./a.out
Hello Write!
➜ ~
```

---

#### 1.1.1.1 システムコールの発行(コール)  3/3

- アプリケーションはカーネルに対し、実行するシステムコールを通知し、CPU のレジスタ(eax, ebx, ecx, ...)へそのパラメータをセットします。

- 例えばi386アーキテクチャでシステムコール番号5（open()の番号です）を通知する場合は、アプリケーションは int 命令を実行する前に、5 を eax レジスタにセットします。(さっきはWriteだったので4番)

- 例えばi386で5つまでのパラメータを渡す場合は、ebx、ecx、edx、esi、ediの各レジスタに、この順序でパラメータをセットします。

- 6つ以上のパラメータを使用する場合は、すべてのパラメータを格納したバッファ（ユーザ空間）へのポインタを1つセットします。

- ほとんどのシステムコールは 2、3 のパラメータしか使用しません。

---
### 1.1.2 Cライブラリ

- Cライブラリ（libc）はUnixアプリケーションの心臓部分です。
- Linux システムの C ライブラリは GNU libc です。glibc（ジーリブシー）
- GNU C ライブラリは多くの機能を備えています。標準 C ライブラリ関数だけではなく、glibc ではシステムコールラッパ、スレッド対応、アプリケーションで必要になる基本機能なども備えています。

Linuxに合わせてC言語を拡張している

---

### 1.1.3 Cコンパイラ

- Linuxでは、標準のCコンパイラはGNU Compiler Collection（gcc）です。
- 現在ではGNUコンパイラファミリの総称となっています。
- gccはCコンパイラを起動するコマンドの名前でもあります。

- 本書でgccと記述した場合は、通常はgccコマンドを指します。必要に応じ文脈から適宜判断してください。

---

## 1.2 API と ABI

- API（application programming interface）
- ABI（application binary interface）です。
- API も ABI も異なる種類のソフトウェア間のインタフェースを定義するものです。
