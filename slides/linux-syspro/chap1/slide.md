---
marp: true
theme: gaia

---

# 1章 概要および主要概念

<style>
{
font-size: 22px;
}
</style>

- Linus Torvalds、LinuxとGit(Linuxを分散開発するために必要だった)を作った人

[![Image from Gyazo](https://i.gyazo.com/81a46bb3d011bc133514477914987640.jpg)](https://gyazo.com/81a46bb3d011bc133514477914987640)

---

## 1.1 システムプログラミング

**X Window System**（エックスウィンドウシステム、別称：「X11」・「X」など）とは、ビットマップディスプレイ上でウィンドウシステムを提供する表示プロトコルである(Wikipediaより)

[![Image from Gyazo](https://i.gyazo.com/3d9a7cf27ef93d84c737e466e656c08e.png)](https://gyazo.com/3d9a7cf27ef93d84c737e466e656c08e)

---

### 1.1.1 システムコール

システムコールとは、ユーザー空間からOSに何らかの動作やリソースを要求するための、カーネル機能を呼び出す物

- read(): ファイルディスクリプターから読み込む
- write(): ファイルディスクリプター (file descriptor) に書き込む
- get_thread_area(): スレッド局所記憶領域を取り出す
- set_tid_Address(): thread IDのポインタを設定する ?

- スレッド局所記憶領域(thread local storage, TLS)
  - グローバル変数がプロセスごとに割り当てる変数
  - スレッドローカル変数はスレッドごとの領域に割り当てられており、その領域をスレッドローカルストレージという

---

#### 1.1.1.1 システムコールの発行 (アセンブリ言語 x86_64 Ubuntu20.04)

<style>
pre > code {
  font-size: 17px;
}
</style>

```assembly
.globl _start
_start:
    /* $の後が数字なら数字、文字なら変数。%はレジスタ */
    movl $4,%eax   /* write システムコール番号 */
    movl $1,%ebx   /* 書き込み先 - 標準出力 */
    movl $msg,%ecx /* 書き込むメッセージ */
    movl $13,%edx  /* メッセージの長さ */
    int $0x80      /* システムコール実行 割り込み実行 */

    movl $1,%eax /* システムコール終了番号 */
    movl $0,%ebx /* 終了状態 */
    int $0x80    /* システムコール終了 割り込み実行 */

.data
    msg: .asciz "Hello,World\n"
```

```sh
➜ ~ as -o main.o main.S
➜ ~ ld -o main.out main.o
➜ ~ ./main.out
hello,World
➜ ~
```

- [アセンブリコードで「int0x80」とはどういう意味ですか？](https://codehero.jp/assembly/1817577/what-does-int-0x80-mean-in-assembly-code)
- [さくっとアセンブリ入門 hello,world編](https://rabbitfoot141.hatenablog.com/entry/2016/05/01/124410)

---

#### 1.1.1.1 システムコールの発行 (C言語)

```c
#include<unistd.h>

int main(){
  const void *string = "Hello,World!\n";
  write(1, string, 13);
  return 0;
}
```

```sh
➜ ~ gcc write.c
➜ ~ ./a.out
Hello World!
➜ ~
```

---

### 1.1.2 Cライブラリ

- 本を読む

---

### 1.1.3 Cコンパイラ

- 本を読む

---

## 1.2 API と ABI

- API（application programming interface）
- ABI（application binary interface）です。
- API も ABI も異なる種類のソフトウェア間のインタフェースを定義するものです。

---

### 1.2.1 API

- APIとは、ソフトウェア間のソースレベルでのインタフェースを定義したもの
- 他のソフトウェアから呼び出し可能なインタフェース(通常は関数)の標準セットを定義し、抽象化したものです。
- 双方のソフトウェアがAPIにしたがっている場合に限り、動作は保証され、ソースレベルの互換性が保たれます

※ 2000年前半の書籍、REST APIではなくライブラリの関数をイメージしていると思われる。Goは標準ライブラリと呼ぶけれど、Javaは標準APIと呼ぶ。
https://docs.oracle.com/javase/jp/11/docs/api/

---

### 1.2.2 ABI

- ABIは特定のアーキテクチャにおけるソフトウェア間の低レベルなバイナリインタフェースを定義したものです
- ABIが保証するのはバイナリレベルの互換性（binary compatibility）です。ABIが同一ならば、リコンパイルせずともオブジェクトコードはどんなシステムでも動作することが保証されます。

Wikipediaより
ABIには、以下のような定義が含まれる。

- **CPU - 命令セット、エンディアンなど。**
- データ - データ型、大きさ、配置（アラインメント）など。
- 呼出規約 - 関数の引数がどのように渡され、リターン値がどのように渡されるかを定義したもの。
- システムコール - システムコール番号と具体的なシステムコールの仕組み。
- 実行ファイルやライブラリの詳細なフォーマット（UNIXならば、COFFやELFなど）。

---

### 1.2.2 ABI 命令セット

コンピュータアーキテクチャ（３）
https://www.mtl.t.u-tokyo.ac.jp/~sakai/hard/hard3.pdf

- 命令セット
  - コンピュータのすべての命令の集まり
- 命令セットアーキテクチャ
  - コンピュータで使われる命令の表現形式と各命令の動作を定めたもの
  - コンピュータに何ができるかをユーザに示し、どのようなハードウェア機構が必要であるかを設計者に教える

---

### 1.2.2 ABI 命令とは

命令 ＝ 操作 op ＋ 対象(オペランド/被演算子)

- オペランド
  - データレジスタ、メモリ語?、プログラムカウンタ、その他のレジスタ、即値

[![Image from Gyazo](https://i.gyazo.com/ee773191a3e9e94e23d941833a430341.png)](https://gyazo.com/ee773191a3e9e94e23d941833a430341)

e-Wordsより

**プログラムカウンタ**とは、マイクロプロセッサ（MPU/CPU）内部でデータを保持するレジスタの一種で、次に実行すべき命令が格納されているメモリ上の番地（アドレス）を保存しているもの。また、その保存しているアドレス値。「PC」と略記されることもある。

---

### 1.2.2 ABI エンディアン

http://www.ertl.jp/~takayuki/readings/info/no05.html

- 32ビットプロセッサなら、一度に32ビットの数値が取り扱います
- 32ビットは4バイトあるけど、どの順番でメモリに書けばいいの?
[![Image from Gyazo](https://i.gyazo.com/afd706c32b8712f30f4330098ec85670.gif)](https://gyazo.com/afd706c32b8712f30f4330098ec85670)

[![Image from Gyazo](https://i.gyazo.com/3163d7194991c2bd258a6fca3faa6bb7.png)](https://gyazo.com/3163d7194991c2bd258a6fca3faa6bb7)[![Image from Gyazo](https://i.gyazo.com/6bbc29aac6c4a36e0598da0828ce52c0.png)](https://gyazo.com/6bbc29aac6c4a36e0598da0828ce52c0)

---

### 1.2.2 ABI エンディアン と 命令セット

[![Image from Gyazo](https://i.gyazo.com/a859a93ac201d7dde5ea2648b75770cd.png)](https://gyazo.com/a859a93ac201d7dde5ea2648b75770cd)

---

### 1.3.1 [補足] POSIX とは

e-Wordsより

- カーネルの機能を呼び出すシステムコールをC言語から利用するためのAPI仕様や標準ライブラリ関数などを定めており、POSIX仕様のみを用いて開発されたプログラムはPOSIX準拠のOSならばどれでも同じように動作させることができる。

- API以外にも、シェルのコマンド体系や、プロセスやスレッドの仕様、ファイルやディレクトリの構成、パスワードファイルなどのシステムデータベースの形式、アーカイブファイルの形式などについても標準を定めている。

---

### 1.3.4 本書での標準仕様の扱い

- 本書ではLinuxカーネルの最新バージョン（2.6）、gcc Cコンパイラ（4.2）、Cライブラリ（2.5）を使用した、現代の Linux システムにおけるシステムプログラミングに集中します。

- ちなみにUbuntu20.04だとKernel(5.10)、gcc(9.3) glibc(2.30)

### 1.4.1 ファイルとファイルシステム - ファイルディスクリプタとは？

>プログラムが特定のファイルを指定して「開く」操作を行うと、カーネル内のファイルテーブルと呼ばれる領域に対応する項目が作成され、対象ファイルのストレージ上での位置（パス）、ファイル内の現在の操作位置などの情報が記録される。
>このテーブル内での当該ファイルの識別番号がファイルディスクリプタで、以降はプログラムからファイルディスクリプタを指定して、どのファイルへの操作なのかをカーネルに伝達する。
>通常、ファイルディスクリプタは0から順番に未使用の最も小さい値が与えられるようになっており、プログラム上では整数型の変数などとして扱われる。ただし、番号によっては固定的に特殊な対象を表す場合があり、一般的には「0」は標準入力（stdin）、「1」は標準出力（stdout）、「2」は標準エラー出力（stderr）としてプログラムの実行中は常に開いた状態になっている。

([IT用語辞典 e-Words](https://e-words.jp/w/%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF.html))

---

#### 1.4.1.1 通常ファイル

 **VMS** など他のオペレーティングシステムでは、レコード（record）などの高度に構造化されたファイルを備えているものもありますが、Linuxにはありません。

Wikipediaより
> OpenVMS (Open Virtual Memory System) は、DECによって設計された、タイムシェアリングシステム、バッチ処理およびトランザクション処理用のオペレーティングシステムである。当初は単にVMSと一般的には呼ばれており...

---

#### 1.4.1.5 スペシャルデバイス - キャラクタデバイス・ブロックデバイス

[![Image from Gyazo](https://i.gyazo.com/c420bec28483b7f85f7938704ef1cd2b.png)](https://gyazo.com/c420bec28483b7f85f7938704ef1cd2b)

> Linuxの場合，キャラクタ・デバイスかブロック・デバイスかは，/devディレクトリ以下のデバイス・ファイル（デバイスをファイルのように扱うためのもの）の情報から確認できます。

> 第1列の「c」で始まるものがキャラクタ・デバイス，「b」で始まるものがブロック・デバイスです。

https://xtech.nikkei.com/it/article/Keyword/20081128/320380/

---

#### 1.4.1.5 スペシャルデバイス - 名前付きパイプ

> 通常のシェルで使用する無名のパイプとは異なり、名前付きパイプはファイルシステムを使用する。mkfifo()[1] または mknod()[2] で明示的に作成し、2つのプロセスが名前を指定してそのパイプにアクセスでき、一方のプロセスは読み手としてオープンし、もう一方は書き手としてオープンする。名前付きパイプを作成する mkfifo というコマンドもある。

> 例えば、名前付きパイプを作成し、そのパイプに入力されたものを gzip で圧縮する場合、次のようにすればよい。

```sh
mkfifo my_pipe
gzip -9 -c < my_pipe > out.gz &
```

https://ja.wikipedia.org/wiki/%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%83%91%E3%82%A4%E3%83%97

---

#### 1.4.1.5 スペシャルデバイス - ソケット

`/var/lib/mysql/mysql.sock`

- ローカルのmysql-serverにmysql-clientで接続するときに使用するソケットファイル
- ソケットファイルを通してSQLを実行する
- mysqlの接続方法はtcp or socket (socketのほうが速いがローカルからしかアクセスできない)

---